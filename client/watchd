#!/usr/bin/env python3

import os
import random
import subprocess
import sys
import tempfile
import threading
import time

import git
import requests
from flask import Flask, jsonify, request, send_from_directory
from flask_cors import CORS
from git import Repo


BASE_DIR = os.path.join(tempfile.gettempdir(), 'watchd')
os.makedirs(BASE_DIR, exist_ok=True)
REPO_DIR = tempfile.mkdtemp(dir=BASE_DIR)


app = Flask(__name__, static_folder=BASE_DIR)
cors = CORS(app, resources={'/*': {'origins': '*'}})


def main(argv):
    assert len(argv) >= 2
    url = argv[1]

    repo = Repo.clone_from(url, REPO_DIR, branch='master')

    print(f'http://127.0.0.1/stream/{os.path.basename(os.path.normpath(REPO_DIR))}')

    while True:
        repo.git.pull('origin', 'master')

        time.sleep(0.1)


@app.route('/', methods=['GET'])
def index():
    repo = Repo(REPO_DIR)

    files = repo.git.ls_files().split()

    return jsonify(files=files)


if __name__ == '__main__':
    m = threading.Thread(target=main, args=(sys.argv,))
    m.start()

    try:
        app.run(host='127.0.0.1', port=1338)
    except OSError:
        pass
    except KeyboardInterrupt:
        exit(0)

    try:
        m.join()
    except KeyboardInterrupt:
        exit(0)
