#!/usr/bin/env python3

import os
import random
import subprocess
import sys
import tempfile
import threading
import time
import shutil
import subprocess
from sys import platform

import git
import requests
from flask import Flask, jsonify, request, send_from_directory
from flask_cors import CORS
from git import Repo


BASE_DIR = os.path.join(tempfile.gettempdir(), 'watchd')
os.makedirs(BASE_DIR, exist_ok=True)

HOLD_FILE = '__STREAMD_HOLD__'


app = Flask(__name__, static_folder=BASE_DIR)
cors = CORS(app, resources={'/*': {'origins': '*'}})


SERVER_HOST = '127.0.0.1'
SERVER_PORT = 1337

CLIENT_HOST = '127.0.0.1'
CLIENT_PORT = 1338


def main(argv):
    assert len(argv) == 2

    url = argv[1]
    repo_dir = os.path.join(BASE_DIR, url.split('/')[-1])

    shutil.rmtree(repo_dir, ignore_errors=True)
    repo = Repo.clone_from(url, repo_dir)

    link = f'http://{SERVER_HOST}:{SERVER_PORT}/stream/{os.path.basename(os.path.normpath(repo_dir))}'
    print(f'Opening {link}')

    if platform == "linux" or platform == "linux2":
        subprocess.run(["xdg-open", link])
    elif platform == "darwin":
        subprocess.run(["open", link])

    while True:
        if not os.path.isfile(os.path.join(repo.working_tree_dir, HOLD_FILE)):
            repo.git.pull('origin', 'master:master')

        time.sleep(0.1)

def mysplit(s):
    try:
        return s[:s.index('/')], s[s.index('/')+1:]
    except:
        return s, []

def flat2nested(s):
    pieces = mysplit(s)
    if pieces[1]:
        return {'name': pieces[0], 'contents': [flat2nested(pieces[1])]}
    else:
        return {'name': pieces[0], 'contents': []}


@app.route('/files/<repo_id>', methods=['GET'])
def files(repo_id):
    repo = Repo(os.path.join(BASE_DIR, repo_id))

    files = repo.git.ls_tree('-r', '--name-only', 'master').split()

    d = {
        'name': 'Source',
        'contents': [flat2nested(f) for f in files]
    }

    return jsonify(d)


@app.route('/commits/<repo_id>', methods=['GET'])
def commits(repo_id):
    repo = Repo(os.path.join(BASE_DIR, repo_id))

    return jsonify(commits=repo.git.log('master', '--reverse', format='%H').split())


@app.route('/commit/<repo_id>/<commit_id>')
def commit(repo_id, commit_id):
    repo = Repo(os.path.join(BASE_DIR, repo_id))

    # interrupt pulls
    open(os.path.join(repo.working_tree_dir, HOLD_FILE), 'w').close()

    repo.git.checkout(commit_id)

    return 'OK'


@app.route('/commit/<repo_id>')
def pull_continue(repo_id):
    try:
        os.remove(os.path.join(BASE_DIR, repo_id, HOLD_FILE))
    except FileNotFoundError:
        pass

    return 'OK'


if __name__ == '__main__':
    m = threading.Thread(target=main, args=(sys.argv,))
    m.start()

    try:
        app.run(host=CLIENT_HOST, port=CLIENT_PORT, debug=True)
    except OSError:
        pass
    except KeyboardInterrupt:
        exit(0)

    try:
        m.join()
    except KeyboardInterrupt:
        exit(0)
